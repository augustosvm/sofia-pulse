# ü§ñ CLAUDE - Sofia Pulse Context (Current)

**Date**: 2025-12-24
**Status**: ‚úÖ InfoJobs Brasil Collector Active

> [!NOTE]
> History moved to `CLAUDE_HISTORY.md` due to size.

---

## üéØ Current Status: Crontab Installed - Automation Starting

**CRITICAL FIX APPLIED** (2025-12-23 20:38 BRT):
- ‚ùå **Previous crontab had ZERO collectors** (only 3 cache jobs)
- ‚úÖ **New crontab installed with 18 collectors**
- ‚úÖ Next execution: Tonight at 00:00 (arbeitnow)
- ‚è≥ First batch: Tomorrow 06:00-12:00 (himalayas, remoteok, npm, etc.)

Successfully unified **70+ collectors** into unified CLI. Automation now properly configured.

### ‚úÖ What's Working (11/13 collectors - 85%)

**Production Server**: `api-tiespecialistas`  
**Last Run**: 704 records inserted in 1m 24s  
**WhatsApp**: Active on 551151990773 (TIE Especialistas)

| Collector | Records/Run | Status |
|:---|:---:|:---|
| GitHub | 100 | ‚úÖ |
| HackerNews | 4 | ‚úÖ |
| StackOverflow | 100 | ‚úÖ |
| Himalayas | 0 | ‚úÖ |
| RemoteOK | Active | ‚úÖ |
| AI Companies | Active | ‚úÖ |
| Universities | Active | ‚úÖ |
| NGOs | Active | ‚úÖ |
| YC Companies | 500 | ‚úÖ |
| NVD | Active | ‚úÖ |
| GDELT | Active | ‚úÖ |

### ‚ùå Known Issues (2 collectors)

| Collector | Error | Impact | Priority |
|:---|:---|:---|:---|
| MDIC Regional | Timeout | Missing Brazil trade data | Medium |
| FIESP Data | Timeout | Missing industry sentiment | Medium |

**CISA**: Removed (permanently blocked HTTP 403)

---

## üìä System Architecture

### Unified CLI
```bash
npx tsx scripts/collect.ts [collector-name]
npx tsx scripts/collect.ts --all
```

### Crontab Schedule (18 Collectors)

**Installed**: 2025-12-23 20:38 BRT
**Generated by**: `npx tsx scripts/generate-crontab.ts --install`

| Frequency | Time | Collectors |
|:---|:---|:---|
| 2x/day | 00:00, 12:00 | github, hackernews |
| 4x/day | 00:00, 06:00, 12:00, 18:00 | himalayas, remoteok |
| 3x/day | 00:00, 08:00, 16:00 | arbeitnow |
| 1x/day | 08:00 | npm |
| 1x/day | 09:00 | stackoverflow |
| 1x/day | 11:00 | producthunt |
| 1x/day | 14:00 | vscode-marketplace |
| 1x/day | 15:00 | jetbrains-marketplace |
| 1x/day | 20:00 | pypi |
| 1x/week (Mon) | 08:00 | arxiv, openalex, ai-companies |
| 1x/week (Mon) | 10:00 | yc-companies |
| 1x/week (Mon) | 06:00 | confs-tech |
| 1x/month (1st) | 08:00 | universities, ngos |

**Total**: 18 collectors with 13 unique schedules

### Data Tables

| Table | Records | Update Frequency | Status |
|:---|:---:|:---|:---|
| `sofia.tech_trends` | 200+ | Hourly | ‚úÖ Active |
| `sofia.jobs` | 7,979+ | Hourly | ‚úÖ Active (NEW: +131 InfoJobs) |
| `sofia.funding_rounds` | 2,577 | Hourly | ‚úÖ Active |
| `sofia.organizations` | Active | Hourly | ‚úÖ Active |
| `sofia.industry_signals` | Active | Hourly | ‚úÖ Active |
| `sofia.comexstat_trade` | 1,596 | - | ‚ö†Ô∏è Not updating |
| `sofia.fiesp_sensor` | 234 | - | ‚ö†Ô∏è Not updating |
| `sofia.data_sources` | 58 | Static | ‚úÖ Compliance |

### 70+ Collectors Unified

**Native TypeScript** (27 collectors):
- Tech Trends: GitHub, HackerNews, NPM, PyPI, StackOverflow
- Jobs: Himalayas, RemoteOK, Arbeitnow
- Organizations: AI Companies, Universities, NGOs
- Funding: YC Companies, Product Hunt
- Industry: NVD, GDELT, Space, AI Regulation
- Developer Tools: VSCode, JetBrains
- Conferences: Confs.tech, Meetup

**Python Bridge** (43+ legacy collectors):
- Security (4), Economic (13), Social/Health (6)
- Women/Gender (6), Sports (3), Jobs (8 - **NEW: InfoJobs Brasil**), Other (4)

---

## üîß Recent Fixes (All in GitHub)

### 1. **CRITICAL: Crontab Not Running Collectors**
**Issue**: Crontab had ZERO collectors, only 3 cache jobs
**Root Cause**: Never ran `generate-crontab.ts --install`
**Fix**: Installed proper crontab with 18 collectors
**Date**: 2025-12-23 20:38 BRT
**Impact**: üî¥ HIGH - System was NOT collecting data automatically

### 2. Python Compatibility
**Issue**: `spawn python ENOENT` on Ubuntu
**Fix**: Changed to `python3` in python-bridge-collector.ts
**Commit**: 3256db7

### 3. WhatsApp Configuration
**Issue**: Using wrong number (027 instead of 011)
**Fix**: Prioritize `WHATSAPP_SENDER` over `WHATSAPP_NUMBER`
**Commit**: 31d024c

### 4. CISA Removal
**Issue**: HTTP 403 (permanently blocked)
**Fix**: Removed from production collector list
**Commit**: de61bdf

### 5. Notification System
**Feature**: WhatsApp notifications with INSERT counts
**Implementation**: `run-collectors-with-notifications.sh`
**Commit**: 57a6e73

### 6. InfoJobs Brasil Web Scraper
**Feature**: New collector for InfoJobs Brasil job listings
**Date**: 2025-12-24
**Implementation**: `scripts/collect-infojobs-web-scraper.py`
**Coverage**: 131 tech jobs inserted on first run
**Keywords**: desenvolvedor, programador, python, javascript, react, node, java, engenheiro de software
**Database**: Uses normalized geographic IDs (country_id, state_id, city_id)
**Status**: ‚úÖ Production ready

---

## üì± WhatsApp Notifications

**Recipient**: 551151990773 (TIE Especialistas)  
**Frequency**: After each collector + final summary

**Format**:
```
‚úÖ github
üìä 100 novos registros
‚è±Ô∏è [1/13]

üèÅ Sofia Pulse - Coleta Finalizada
‚úÖ Sucesso: 11/13 (85%)
‚ùå Falhas: 2/13
üìä Total Inserido: 704 registros
‚è±Ô∏è Dura√ß√£o: 1m 24s
```

---

## ‚úÖ Recent Completions (2025-12-23)

### 1. Fixed Regional Cache Error
- ‚ùå Error: `column "institution_country_name" does not exist`
- ‚úÖ Fixed: Changed to `institution_country` in generate-regional-cache-v5-final.ts

### 2. Normalized 30+ Database Tables
**High Priority Tables (>10k rows):**
- gender_indicators (874k) - 99.9% coverage
- women_eurostat_data (808k) - 100% coverage
- persons (227k) - 100% coverage (where country exists)
- acled_aggregated (198k) - 97.4% coverage
- socioeconomic_indicators (95k) - 77.8% coverage
- women_world_bank_data (63k) - 98.8% coverage
- who_health_data (48k) - 100% coverage
- world_tourism_data (19k) - 96.5% coverage

**Medium Priority Tables (1k-10k rows):**
- world_drugs_data (10k) - 100%
- space_industry (6.2k) - 94%
- world_sports_data (5.5k) - 99.9%
- fao_agriculture_data (4.4k) - 100%
- women_ilo_data (3.8k) - 98%
- world_security_data (3.4k) - 100%
- cepal_latam_data (3.4k) - 100%
- unicef_children_data (3.1k) - 100%
- port_traffic (2.5k) - 72.9%
- central_banks_women_data (2.2k) - 100%

**All normalized tables now have:**
- `country_id` foreign key to `sofia.countries`
- Foreign key constraints for referential integrity
- Average coverage: 95%+

### 3. Created Geographic Helper Functions
**Location**: `scripts/shared/geo-id-helpers.ts` (TypeScript) + `geo_id_helpers.py` (Python)

**Functions**:
- `getCountryId(pool, countryName)` - Lookup by ISO codes or name
- `getStateId(pool, stateName, countryId)` - Lookup state within country
- `getCityId(pool, cityName, stateId, countryId)` - Lookup city
- `getReligionId(pool, religionName)` - Lookup religion
- `getCountryIdsBatch(pool)` - Bulk load for performance

## üîú Pending Tasks

### Priority 1: ‚úÖ DONE - Database Normalization
- [x] Audited 69 tables for geographic data
- [x] Normalized 30+ high/medium priority tables
- [x] Created helper functions for ID lookups
- [ ] **NEXT**: Update collectors to use helper functions

### Priority 2: Update Collectors to Use Normalized IDs
- [ ] Update jobs collectors (20+ collectors) to use country_id/state_id/city_id
- [ ] Update women data collectors to use country_id
- [ ] Update world data collectors to use country_id
- [ ] Test updated collectors locally
- [ ] Deploy to production

### Priority 3: ‚úÖ DONE - Crontab Installation
- [x] Discovered crontab had ZERO collectors
- [x] Installed proper crontab with 18 collectors
- [x] Backed up old crontab
- [x] Set execute permissions
- [ ] **NEXT**: Verify first automated runs (check logs tomorrow)

### Priority 2: Production Server Deployment
- [ ] SSH into `api-tiespecialistas` server
- [ ] Run `npx tsx scripts/generate-crontab.ts --install` on server
- [ ] Verify crontab on server: `crontab -l`
- [ ] Monitor first runs: `tail -f logs/*-collector.log`
- [ ] Update WhatsApp notifications if needed

### Priority 3: Fix MDIC & FIESP Timeouts
- [ ] Investigate python3 compatibility issues
- [ ] Test with increased timeout (currently 300s)
- [ ] Verify API endpoints are accessible
- [ ] Check file permissions for FIESP Excel files

### Priority 4: Improve Insert Tracking
- [ ] Some collectors show "?" for insert counts
- [ ] Standardize output format across all collectors
- [ ] Better regex patterns in notification script

### Priority 5: Monitoring & Alerts
- [ ] Add Grafana dashboard for collector metrics
- [ ] Alert on repeated failures (3+ consecutive)
- [ ] Track insert trends over time
- [ ] Monitor API rate limits

---

## üöÄ Deployment Commands

### Update Code
```bash
cd /home/ubuntu/sofia-pulse
git pull origin master
```

### Run Collectors
```bash
./run-collectors-with-notifications.sh
```

### Check Status
```bash
sudo systemctl status sofia-pulse-collectors.timer
tail -f logs/collectors-*.log
```

### View Database
```sql
-- Recent collector runs
SELECT collector_name, status, started_at, completed_at 
FROM sofia.collector_runs 
ORDER BY started_at DESC 
LIMIT 20;

-- Data freshness
SELECT source, COUNT(*), MAX(collected_at) as last_update
FROM sofia.tech_trends
GROUP BY source;
```

---

## üìà Success Metrics

- ‚úÖ **Unification**: 70+ collectors ‚Üí 1 CLI
- ‚úÖ **Automation**: Systemd timer active (hourly)
- ‚úÖ **Notifications**: WhatsApp working (551151990773)
- ‚úÖ **Governance**: 58 sources tracked in `data_sources`
- ‚úÖ **Production**: 85% success rate (11/13)
- ‚úÖ **Code Quality**: All fixes in GitHub (no manual edits)

---

## üêõ Troubleshooting

### Collectors Not Running
```bash
# Check systemd
sudo systemctl status sofia-pulse-collectors.timer
sudo journalctl -u sofia-pulse-collectors.service -f

# Check logs
tail -100 logs/collectors-*.log

# Test manually
npx tsx scripts/collect.ts github
```

### WhatsApp Not Sending
```bash
# Verify .env
grep WHATSAPP .env

# Check API
curl http://91.98.158.19:3001/status

# Test integration
python3 scripts/utils/sofia_whatsapp_integration.py
```

### Database Connection Issues
```bash
# Verify .env
grep DB_ .env

# Test connection
psql -h localhost -U sofia -d sofia_db
```

---

## üìù Documentation

- **Setup Guide**: `SERVER_SETUP.md`
- **Deploy Guide**: `DEPLOY_GUIDE.md`
- **Walkthrough**: `walkthrough.md`
- **Task List**: `task.md`
- **History**: `CLAUDE_HISTORY.md`

---

**Status**: üü¢ **PRODUCTION ACTIVE**  
**Next Execution**: Automatic (hourly via systemd)  
**Monitoring**: WhatsApp notifications enabled

---

*Last Updated: 2025-12-24 10:45 BRT*

---

## üéâ Latest Updates (2025-12-24)

### ‚úÖ Geographic Normalization Complete!

**All 68 collectors now use normalized geographic IDs automatically!**

**What changed:**
1. ‚úÖ Created `geo-id-helpers.ts` and `geo_id_helpers.py` with intelligent lookup functions
2. ‚úÖ Updated `geo-helpers.ts/py` to use new lookup functions (no more get_or_create)
3. ‚úÖ Added UNIQUE constraint to `jobs` table: `(job_id, platform)`
4. ‚úÖ Normalized 30+ tables with 95%+ coverage
5. ‚úÖ All collectors automatically inherit normalized IDs via `normalizeLocation()`

**Impact:**
- üéØ ZERO individual collector updates needed!
- üîí Prevents duplicate countries/states/cities
- üìä All new data uses normalized foreign keys
- ‚ö° Backwards compatible (existing collectors work unchanged)

**Tables Normalized (Coverage):**
- gender_indicators (874k) ‚Üí 99.9%
- women_eurostat_data (808k) ‚Üí 100%
- persons (227k) ‚Üí 100%
- who_health_data (48k) ‚Üí 100%
- world_drugs_data (10k) ‚Üí 100%
- + 25 more tables

**Git Commit**: `b2d4deb` - Pushed to master

---

*Last Updated: 2025-12-24 10:45 BRT*
